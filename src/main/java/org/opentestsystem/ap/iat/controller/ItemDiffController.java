package org.opentestsystem.ap.iat.controller;

import java.util.List;

import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.servlet.ModelAndView;

@Slf4j
@Controller
public class ItemDiffController {

    private final RestTemplate restTemplate;

    @Autowired
    public ItemDiffController(final RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @RequestMapping("/diff/item/{itemId}/history/{historyId}")
    public ModelAndView getDiff(@PathVariable String itemId, @PathVariable String historyId) {
        log.debug("Getting diff for item {} and history ID {}", itemId, historyId);

        final ResponseEntity<List<ItemDiff>> response = restTemplate.exchange
            ("http://localhost:8081/api/v1/items/{itemId}/diff/{historyId}",
                HttpMethod.GET,
                null,
                new ParameterizedTypeReference<List<ItemDiff>>() {
                },
                itemId,
                historyId);

        final List<ItemDiff> diffList = response.getBody();

        String itemDiff = diffList.stream().map(diff -> diff.getDiff()).reduce("", String::concat);

        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("itemdiff");
        modelAndView.addObject("diff", itemDiff);

        return modelAndView;
    }

    @Data
    public static class ItemDiff {
        private String diff;
    }
}
